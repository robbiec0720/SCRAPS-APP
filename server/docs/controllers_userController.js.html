<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/userController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/userController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
const db = require('../config/db');
const user = require('../models/user');

/**
 * @module Controllers
 * @description Defines controller functions for user-related functionality..
 */


/**
 * Gets all users in Postgres database
 * @controller
 * @function getUsers
 * @param {Object} req - the HTTP Request Object
 * @param {Object} res - The HTTP response Object
 * @returns {void}
 * @throws {Error} If an error occurs while querying the database
 */
const getUsers = (req, res) => {
  db.query(user.getUsers, (err, results) => {
    if (err) throw err;
    res.status(200).json(results.rows);
  });
};

/**
 * Creates a new user in the Postgres database.
 * @controller
 * @function createUser
 * @param {Object} req - The HTTP Request Object.
 * @param {Object} res - The HTTP Response Object.
 * @returns {void}
 */
const createUser = (req, res) => {
  const {username, email, password } = req.body;

  if (!username){
    return res.status(400).send({
      success:false,
      message: "username required"
    })
  }
  if (!email){
    return res.status(400).send({
      success:false,
      message: "email required"
    })
  }
  if (!password){
    return res.status(400).send({
      success:false,
      message: "password required"
    })
  }

  db.query(user.checkEmail, [email], (err, results)=> {
    if (results.rows.length) {
      return res.status(500).send({
        success:false,
        message:'email already exists'
      })
    }
    
    db.query(user.createUser, [username, email, password], (err, results) => {
      if (err) throw err;
      return res.status(201).send({
        success:true,
        message:'account created successfully'
      });
    })

  });
};

/**
 * Authenticates a user's login credentials.
 * @function userLogin
 * @param {Object} req - The HTTP Request Object.
 * @param {Object} res - The HTTP Response Object.
 * @returns {void}
 */
const userLogin = (req, res) => {
   const {username, password} = req.body;
   if (!username || !password){
    return res.status(500).send({
      success:false,
      message: 'Please provide username or password'
    });
   };

   db.query(user.checkUserExistsByUsername, [username, password], (err, results) => {
    if (err) throw err;

    //const count = parseInt(results.rows[0].count);
    if (results.rows.length != 0) {
       return res.status(201).send({
        success:true,
        message:'login successful',
        user: { 
          id: results.rows[0].id,
          username: results.rows[0].username,
          email: results.rows[0].email,
          vegetarian: results.rows[0].vegetarian,
          vegan: results.rows[0].vegan,
          halal: results.rows[0].halal,
          kosher: results.rows[0].kosher,
          lactose: results.rows[0].lactose,
          gluten: results.rows[0].gluten,
          nut: results.rows[0].nut,
          shellfish: results.rows[0].shellfish,
          pescatarian: results.rows[0].pescatarian,
          saved_ingredients: results.rows[0].saved_ingredients,
        }
      });
    };
    
    return res.status(404).send({
      success:false,
      message:'login unsuccessful'
    })

  });
};

/**
 * Resets a user's password in the Postgres database.
 * @function resetPassword
 * @param {Object} req - The HTTP Request Object.
 * @param {Object} res - The HTTP Response Object.
 * @returns {void}
 */
const resetPassword = (req, res) => {
  const {oldPassword, email, newPassword} = req.body;
  if (!oldPassword || !email || !newPassword){
    return res.status(500).send({
      success:false,
      message: 'Please provide username or password'
    });
   };

  db.query(user.checkUserExistsByEmail, [email,oldPassword], (err, results) => {
    if (results.rows.length == 0) {
      return res.status(500).send({
        success:false,
        message:'user does not exist'
      });
    }
    db.query(user.resetPassword, [newPassword, email, oldPassword], (err, results) => {
      return res.status(201).send({
        success:true,
        message:'password reset successfully'
      })
    });
  }); 
};

/**
 * Resets a user's email address in the Postgres database.
 * @function resetEmail
 * @param {Object} req - The HTTP Request Object.
 * @param {Object} res - The HTTP Response Object.
 * @returns {void}
 */
const resetEmail = (req, res) => {
  const {oldEmail, newEmail, password} = req.body;

  if (!oldEmail || !newEmail || !password){
    return res.status(500).send({
      success:false,
      message: 'Please provide username or password'
    });
   };

  db.query(user.checkUserExistsByEmail, [oldEmail,password], (err, results) => {
    if (results.rows.length == 0) {
      return res.status(500).send({
        success:false,
        message:'user does not exist'
      });
    }
    db.query(user.resetEmail, [newEmail,oldEmail, password], (err, results) => {
      return res.status(201).send({
        success:true,
        message:'email reset successfully'
      })
    });
  }); 
};

/**
 * Updates a user's dietary restrictions in the Postgres database.
 * @function updateDietaryRestrictions
 * @param {Object} req - The HTTP Request Object.
 * @param {Object} res - The HTTP Response Object.
 * @returns {void}
 */
const updateDietaryRestrictions = (req, res) => {

  const { vegetarian, vegan, halal, kosher, 
    lactose, gluten, nut, shellfish, pescatarian, id } = req.body;

  console.log(vegetarian);

  db.query(user.updateDietaryRestrictions, [
    vegetarian,
    vegan,
    halal,
    kosher,
    lactose,
    gluten,
    nut,
    shellfish,
    pescatarian,
    id
  ], (err, results) => {
    if (err) {
      console.error('Error updating dietary restrictions:', err);
      return res.status(500).json({ success: false, message: 'Internal Server Error' });
    }

    // Return success response
    return res.status(201).json({ success: true, message: 'Dietary restrictions updated' });
  });
}


module.exports = {
  getUsers,
  createUser,
  userLogin,
  resetPassword,
  resetEmail,
  updateDietaryRestrictions,
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Controllers.html">Controllers</a></li><li><a href="module-Models.html">Models</a></li><li><a href="module-Routes.html">Routes</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Tue Apr 30 2024 19:56:49 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
